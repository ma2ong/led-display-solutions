{% extends "base.html" %}

{% block title %}Inquiry Management - Admin Panel{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Inquiry Management</h1>
        <div>
            <button class="btn btn-success" onclick="exportInquiries()">
                <i class="fas fa-download"></i> Export CSV
            </button>
            <button class="btn btn-primary" onclick="refreshInquiries()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label for="statusFilter" class="form-label">Status</label>
                    <select id="statusFilter" class="form-select">
                        <option value="">All Statuses</option>
                        <option value="new">New</option>
                        <option value="contacted">Contacted</option>
                        <option value="quoted">Quoted</option>
                        <option value="closed">Closed</option>
                        <option value="lost">Lost</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="priorityFilter" class="form-label">Priority</label>
                    <select id="priorityFilter" class="form-select">
                        <option value="">All Priorities</option>
                        <option value="high">High</option>
                        <option value="normal">Normal</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="typeFilter" class="form-label">Type</label>
                    <select id="typeFilter" class="form-select">
                        <option value="">All Types</option>
                        <option value="general">General</option>
                        <option value="quote">Quote Request</option>
                        <option value="technical">Technical</option>
                        <option value="partnership">Partnership</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="dateFilter" class="form-label">Date Range</label>
                    <select id="dateFilter" class="form-select">
                        <option value="">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="quarter">This Quarter</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search by name, email, or company...">
                </div>
                <div class="col-md-6">
                    <button class="btn btn-outline-primary" onclick="applyFilters()">Apply Filters</button>
                    <button class="btn btn-outline-secondary" onclick="clearFilters()">Clear</button>
                    <div class="float-end">
                        <button class="btn btn-outline-success" onclick="bulkAction('assign')">
                            <i class="fas fa-user-plus"></i> Bulk Assign
                        </button>
                        <button class="btn btn-outline-info" onclick="bulkAction('status')">
                            <i class="fas fa-edit"></i> Bulk Status
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">New</h6>
                            <h4 class="mb-0" id="stat-new">-</h4>
                        </div>
                        <i class="fas fa-envelope fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">In Progress</h6>
                            <h4 class="mb-0" id="stat-contacted">-</h4>
                        </div>
                        <i class="fas fa-clock fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">High Priority</h6>
                            <h4 class="mb-0" id="stat-high-priority">-</h4>
                        </div>
                        <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Closed</h6>
                            <h4 class="mb-0" id="stat-closed">-</h4>
                        </div>
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inquiries Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th>Customer</th>
                            <th>Company</th>
                            <th>Product Interest</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Assigned To</th>
                            <th>Value</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inquiriesTableBody">
                        <tr>
                            <td colspan="11" class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <nav aria-label="Inquiries pagination">
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- Pagination will be generated by JavaScript -->
                </ul>
            </nav>
        </div>
    </div>

    <!-- Inquiry Detail Modal -->
    <div class="modal fade" id="inquiryDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Inquiry Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <!-- Inquiry Information -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0">Inquiry Information</h6>
                                </div>
                                <div class="card-body" id="inquiryInfo">
                                    <!-- Content will be populated by JavaScript -->
                                </div>
                            </div>
                            
                            <!-- Follow-up History -->
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Follow-up History</h6>
                                </div>
                                <div class="card-body">
                                    <div id="followupHistory">
                                        <!-- Content will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <!-- Quick Actions -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0">Quick Actions</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="inquiryStatus" class="form-label">Status</label>
                                        <select id="inquiryStatus" class="form-select">
                                            <option value="new">New</option>
                                            <option value="contacted">Contacted</option>
                                            <option value="quoted">Quoted</option>
                                            <option value="closed">Closed</option>
                                            <option value="lost">Lost</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="inquiryPriority" class="form-label">Priority</label>
                                        <select id="inquiryPriority" class="form-select">
                                            <option value="low">Low</option>
                                            <option value="normal">Normal</option>
                                            <option value="high">High</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="assignedUser" class="form-label">Assign To</label>
                                        <select id="assignedUser" class="form-select">
                                            <option value="">Unassigned</option>
                                            <!-- Users will be populated by JavaScript -->
                                        </select>
                                    </div>
                                    <button class="btn btn-primary w-100" onclick="updateInquiry()">
                                        Update Inquiry
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Add Follow-up -->
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Add Follow-up</h6>
                                </div>
                                <div class="card-body">
                                    <form id="followupForm">
                                        <div class="mb-3">
                                            <label for="actionType" class="form-label">Action Type</label>
                                            <select id="actionType" class="form-select" required>
                                                <option value="">Select Action</option>
                                                <option value="call">Phone Call</option>
                                                <option value="email">Email Sent</option>
                                                <option value="meeting">Meeting</option>
                                                <option value="quote_sent">Quote Sent</option>
                                                <option value="sample_sent">Sample Sent</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="followupSubject" class="form-label">Subject</label>
                                            <input type="text" id="followupSubject" class="form-control">
                                        </div>
                                        <div class="mb-3">
                                            <label for="followupNotes" class="form-label">Notes</label>
                                            <textarea id="followupNotes" class="form-control" rows="3" required></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="nextAction" class="form-label">Next Action</label>
                                            <input type="text" id="nextAction" class="form-control">
                                        </div>
                                        <div class="mb-3">
                                            <label for="nextActionDate" class="form-label">Next Action Date</label>
                                            <input type="date" id="nextActionDate" class="form-control">
                                        </div>
                                        <button type="submit" class="btn btn-success w-100">
                                            Add Follow-up
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let itemsPerPage = 10;
let selectedInquiries = new Set();
let currentInquiryId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadInquiries();
    loadStatistics();
    
    // Setup form submission
    document.getElementById('followupForm').addEventListener('submit', handleAddFollowup);
    
    // Setup search
    document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 500));
});

async function loadInquiries(page = 1) {
    try {
        const params = new URLSearchParams({
            limit: itemsPerPage,
            offset: (page - 1) * itemsPerPage
        });
        
        // Add filters
        const statusFilter = document.getElementById('statusFilter').value;
        const priorityFilter = document.getElementById('priorityFilter').value;
        const typeFilter = document.getElementById('typeFilter').value;
        const searchInput = document.getElementById('searchInput').value;
        
        if (statusFilter) params.append('status', statusFilter);
        if (priorityFilter) params.append('priority', priorityFilter);
        if (typeFilter) params.append('type', typeFilter);
        if (searchInput) params.append('search', searchInput);
        
        const response = await fetch(`/api/admin/inquiries?${params}`);
        const data = await response.json();
        
        if (data.success) {
            displayInquiries(data.inquiries);
            updatePagination(data.count);
            currentPage = page;
        } else {
            showError('Failed to load inquiries: ' + data.error);
        }
    } catch (error) {
        console.error('Error loading inquiries:', error);
        showError('Failed to load inquiries');
    }
}

async function loadStatistics() {
    try {
        const response = await fetch('/api/admin/dashboard-stats');
        const data = await response.json();
        
        if (data.success) {
            const stats = data.stats;
            document.getElementById('stat-new').textContent = stats.new_inquiries || 0;
            document.getElementById('stat-contacted').textContent = stats.contacted_inquiries || 0;
            document.getElementById('stat-high-priority').textContent = stats.high_priority || 0;
            document.getElementById('stat-closed').textContent = stats.closed_inquiries || 0;
        }
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

function displayInquiries(inquiries) {
    const tbody = document.getElementById('inquiriesTableBody');
    
    if (inquiries.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted">No inquiries found</td></tr>';
        return;
    }
    
    tbody.innerHTML = inquiries.map(inquiry => `
        <tr>
            <td>
                <input type="checkbox" class="inquiry-checkbox" value="${inquiry.id}" 
                       onchange="toggleInquirySelection(${inquiry.id})">
            </td>
            <td>
                <div>
                    <strong>${inquiry.name}</strong>
                    <br><small class="text-muted">${inquiry.email}</small>
                </div>
            </td>
            <td>${inquiry.company || '-'}</td>
            <td>
                <span class="badge bg-info">${inquiry.product_interest || 'General'}</span>
            </td>
            <td>
                <span class="badge bg-secondary">${inquiry.inquiry_type}</span>
            </td>
            <td>
                <span class="badge bg-${getStatusColor(inquiry.status)}">${inquiry.status}</span>
            </td>
            <td>
                <span class="badge bg-${getPriorityColor(inquiry.priority)}">${inquiry.priority}</span>
            </td>
            <td>${inquiry.assigned_user || 'Unassigned'}</td>
            <td>
                ${inquiry.estimated_value ? '$' + parseFloat(inquiry.estimated_value).toLocaleString() : '-'}
            </td>
            <td>
                <small>${formatDate(inquiry.created_at)}</small>
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewInquiry(${inquiry.id})" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-success" onclick="replyToInquiry(${inquiry.id})" title="Reply">
                        <i class="fas fa-reply"></i>
                    </button>
                    <button class="btn btn-outline-info" onclick="addFollowup(${inquiry.id})" title="Add Follow-up">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

async function viewInquiry(inquiryId) {
    try {
        const response = await fetch(`/api/admin/inquiries/${inquiryId}`);
        const data = await response.json();
        
        if (data.success) {
            currentInquiryId = inquiryId;
            displayInquiryDetails(data.inquiry);
            const modal = new bootstrap.Modal(document.getElementById('inquiryDetailModal'));
            modal.show();
        } else {
            showError('Failed to load inquiry details: ' + data.error);
        }
    } catch (error) {
        console.error('Error loading inquiry details:', error);
        showError('Failed to load inquiry details');
    }
}

function displayInquiryDetails(inquiry) {
    // Populate inquiry information
    document.getElementById('inquiryInfo').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <p><strong>Name:</strong> ${inquiry.name}</p>
                <p><strong>Email:</strong> <a href="mailto:${inquiry.email}">${inquiry.email}</a></p>
                <p><strong>Company:</strong> ${inquiry.company || 'N/A'}</p>
                <p><strong>Phone:</strong> ${inquiry.phone || 'N/A'}</p>
                <p><strong>Country:</strong> ${inquiry.country || 'N/A'}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Product Interest:</strong> ${inquiry.product_interest || 'General'}</p>
                <p><strong>Inquiry Type:</strong> ${inquiry.inquiry_type}</p>
                <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(inquiry.status)}">${inquiry.status}</span></p>
                <p><strong>Priority:</strong> <span class="badge bg-${getPriorityColor(inquiry.priority)}">${inquiry.priority}</span></p>
                <p><strong>Estimated Value:</strong> ${inquiry.estimated_value ? '$' + parseFloat(inquiry.estimated_value).toLocaleString() : 'N/A'}</p>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <p><strong>Message:</strong></p>
                <div class="bg-light p-3 rounded">${inquiry.message}</div>
            </div>
        </div>
    `;
    
    // Set form values
    document.getElementById('inquiryStatus').value = inquiry.status;
    document.getElementById('inquiryPriority').value = inquiry.priority;
    document.getElementById('assignedUser').value = inquiry.assigned_to || '';
    
    // Display follow-up history
    if (inquiry.followups && inquiry.followups.length > 0) {
        document.getElementById('followupHistory').innerHTML = inquiry.followups.map(followup => `
            <div class="border-start border-3 border-primary ps-3 mb-3">
                <div class="d-flex justify-content-between">
                    <strong>${followup.action_type.replace('_', ' ').toUpperCase()}</strong>
                    <small class="text-muted">${formatDate(followup.created_at)}</small>
                </div>
                ${followup.subject ? `<div class="fw-bold">${followup.subject}</div>` : ''}
                <div>${followup.notes}</div>
                ${followup.next_action ? `<div class="text-muted"><small>Next: ${followup.next_action} ${followup.next_action_date ? '(' + followup.next_action_date + ')' : ''}</small></div>` : ''}
                <div class="text-muted"><small>By: ${followup.username}</small></div>
            </div>
        `).join('');
    } else {
        document.getElementById('followupHistory').innerHTML = '<p class="text-muted">No follow-up history available.</p>';
    }
}

async function handleAddFollowup(e) {
    e.preventDefault();
    
    if (!currentInquiryId) {
        showError('No inquiry selected');
        return;
    }
    
    const formData = new FormData(e.target);
    const data = {
        action_type: document.getElementById('actionType').value,
        subject: document.getElementById('followupSubject').value,
        notes: document.getElementById('followupNotes').value,
        next_action: document.getElementById('nextAction').value,
        next_action_date: document.getElementById('nextActionDate').value
    };
    
    try {
        const response = await fetch(`/api/admin/inquiries/${currentInquiryId}/followup`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess('Follow-up added successfully');
            e.target.reset();
            // Reload inquiry details
            viewInquiry(currentInquiryId);
        } else {
            showError('Failed to add follow-up: ' + result.error);
        }
    } catch (error) {
        console.error('Error adding follow-up:', error);
        showError('Failed to add follow-up');
    }
}

async function updateInquiry() {
    if (!currentInquiryId) {
        showError('No inquiry selected');
        return;
    }
    
    const status = document.getElementById('inquiryStatus').value;
    
    try {
        const response = await fetch(`/api/admin/inquiries/${currentInquiryId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess('Inquiry updated successfully');
            loadInquiries(currentPage);
            loadStatistics();
        } else {
            showError('Failed to update inquiry: ' + result.error);
        }
    } catch (error) {
        console.error('Error updating inquiry:', error);
        showError('Failed to update inquiry');
    }
}

function replyToInquiry(inquiryId) {
    showInfo('Email reply functionality will be implemented in the next phase');
}

function addFollowup(inquiryId) {
    viewInquiry(inquiryId);
}

function applyFilters() {
    currentPage = 1;
    loadInquiries(1);
}

function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('priorityFilter').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('dateFilter').value = '';
    document.getElementById('searchInput').value = '';
    applyFilters();
}

function refreshInquiries() {
    loadInquiries(currentPage);
    loadStatistics();
}

async function exportInquiries() {
    try {
        const response = await fetch('/api/admin/inquiries/export');
        const blob = await response.blob();
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `inquiries_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showSuccess('Inquiries exported successfully');
    } catch (error) {
        console.error('Export error:', error);
        showError('Failed to export inquiries');
    }
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.inquiry-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
        toggleInquirySelection(parseInt(checkbox.value));
    });
}

function toggleInquirySelection(inquiryId) {
    if (selectedInquiries.has(inquiryId)) {
        selectedInquiries.delete(inquiryId);
    } else {
        selectedInquiries.add(inquiryId);
    }
}

function bulkAction(action) {
    if (selectedInquiries.size === 0) {
        showError('Please select at least one inquiry');
        return;
    }
    
    showInfo(`Bulk ${action} functionality will be implemented in the next phase`);
}

// Utility functions
function getStatusColor(status) {
    const colors = {
        'new': 'primary',
        'contacted': 'info',
        'quoted': 'warning',
        'closed': 'success',
        'lost': 'secondary'
    };
    return colors[status] || 'secondary';
}

function getPriorityColor(priority) {
    const colors = {
        'low': 'secondary',
        'normal': 'info',
        'high': 'warning'
    };
    return colors[priority] || 'info';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 1) return 'Today';
    if (diffDays === 2) return 'Yesterday';
    if (diffDays <= 7) return `${diffDays - 1} days ago`;
    
    return date.toLocaleDateString();
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showSuccess(message) {
    showToast(message, 'success');
}

function showError(message) {
    showToast(message, 'danger');
}

function showInfo(message) {
    showToast(message, 'info');
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
                </div>
                <div class="col-md-3">
                    <label for="searchInput" class="form-label">Search</label>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search name, email, company...">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button class="btn btn-outline-secondary" onclick="clearFilters()">Clear Filters</button>
                    <span class="ms-3 text-muted">
                        Showing <span id="inquiry-count">0</span> inquiries
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Inquiries Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th>ID</th>
                            <th>Priority</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Company</th>
                            <th>Product Interest</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inquiries-tbody">
                        <tr>
                            <td colspan="11" class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <nav aria-label="Inquiries pagination" class="mt-4">
        <ul class="pagination justify-content-center" id="pagination">
            <!-- Pagination will be populated by JavaScript -->
        </ul>
    </nav>

    <!-- Bulk Actions -->
    <div class="card mt-4" id="bulkActions" style="display: none;">
        <div class="card-body">
            <h6>Bulk Actions</h6>
            <div class="btn-group" role="group">
                <button class="btn btn-outline-primary" onclick="bulkUpdateStatus('contacted')">Mark as Contacted</button>
                <button class="btn btn-outline-success" onclick="bulkUpdateStatus('closed')">Mark as Closed</button>
                <button class="btn btn-outline-danger" onclick="bulkDelete()">Delete Selected</button>
            </div>
            <span class="ms-3 text-muted">
                <span id="selected-count">0</span> inquiries selected
            </span>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let totalPages = 1;
let selectedInquiries = new Set();
let allInquiries = [];

document.addEventListener('DOMContentLoaded', function() {
    loadInquiries();
    setupFilters();
});

function setupFilters() {
    const filters = ['statusFilter', 'priorityFilter', 'typeFilter', 'searchInput'];
    filters.forEach(filterId => {
        document.getElementById(filterId).addEventListener('change', () => {
            currentPage = 1;
            loadInquiries();
        });
    });
    
    // Debounce search input
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentPage = 1;
            loadInquiries();
        }, 500);
    });
}

async function loadInquiries() {
    try {
        const params = new URLSearchParams({
            page: currentPage,
            limit: 20,
            status: document.getElementById('statusFilter').value,
            priority: document.getElementById('priorityFilter').value,
            type: document.getElementById('typeFilter').value,
            search: document.getElementById('searchInput').value
        });
        
        const response = await fetch(`/api/admin/inquiries?${params}`);
        const data = await response.json();
        
        displayInquiries(data.inquiries || data);
        updatePagination(data.pagination);
        updateInquiryCount(data.total || data.length);
        
    } catch (error) {
        console.error('Error loading inquiries:', error);
        showError('Failed to load inquiries');
    }
}

function displayInquiries(inquiries) {
    const tbody = document.getElementById('inquiries-tbody');
    
    if (inquiries.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted">No inquiries found</td></tr>';
        return;
    }
    
    tbody.innerHTML = inquiries.map(inquiry => `
        <tr class="${selectedInquiries.has(inquiry.id) ? 'table-active' : ''}">
            <td>
                <input type="checkbox" class="inquiry-checkbox" value="${inquiry.id}" 
                       ${selectedInquiries.has(inquiry.id) ? 'checked' : ''} 
                       onchange="toggleInquirySelection(${inquiry.id})">
            </td>
            <td>#${inquiry.id}</td>
            <td>
                <span class="badge bg-${getPriorityColor(inquiry.priority || 'normal')}">
                    ${(inquiry.priority || 'normal').toUpperCase()}
                </span>
            </td>
            <td>
                <strong>${inquiry.name}</strong>
                ${inquiry.country ? `<br><small class="text-muted">${inquiry.country}</small>` : ''}
            </td>
            <td>
                <a href="mailto:${inquiry.email}">${inquiry.email}</a>
            </td>
            <td>${inquiry.company || '-'}</td>
            <td>
                ${inquiry.product_interest ? 
                    `<span class="badge bg-light text-dark">${formatProductInterest(inquiry.product_interest)}</span>` : 
                    '-'
                }
            </td>
            <td>
                <span class="badge bg-secondary">${(inquiry.inquiry_type || 'general').toUpperCase()}</span>
            </td>
            <td>
                <select class="form-select form-select-sm" onchange="updateInquiryStatus(${inquiry.id}, this.value)">
                    <option value="new" ${inquiry.status === 'new' ? 'selected' : ''}>New</option>
                    <option value="contacted" ${inquiry.status === 'contacted' ? 'selected' : ''}>Contacted</option>
                    <option value="quoted" ${inquiry.status === 'quoted' ? 'selected' : ''}>Quoted</option>
                    <option value="closed" ${inquiry.status === 'closed' ? 'selected' : ''}>Closed</option>
                    <option value="lost" ${inquiry.status === 'lost' ? 'selected' : ''}>Lost</option>
                </select>
            </td>
            <td>
                <small>${formatDate(inquiry.created_at)}</small>
            </td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-primary" onclick="viewInquiry(${inquiry.id})" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-success" onclick="replyToInquiry(${inquiry.id})" title="Reply">
                        <i class="fas fa-reply"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteInquiry(${inquiry.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function updatePagination(pagination) {
    if (!pagination) return;
    
    totalPages = pagination.pages;
    currentPage = pagination.current;
    
    const paginationEl = document.getElementById('pagination');
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
        </li>
    `;
    
    // Page numbers
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        paginationHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
        `;
    }
    
    // Next button
    paginationHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
        </li>
    `;
    
    paginationEl.innerHTML = paginationHTML;
}

function changePage(page) {
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    loadInquiries();
}

function updateInquiryCount(count) {
    document.getElementById('inquiry-count').textContent = count;
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.inquiry-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
        const inquiryId = parseInt(checkbox.value);
        if (selectAll.checked) {
            selectedInquiries.add(inquiryId);
        } else {
            selectedInquiries.delete(inquiryId);
        }
    });
    
    updateBulkActions();
}

function toggleInquirySelection(inquiryId) {
    if (selectedInquiries.has(inquiryId)) {
        selectedInquiries.delete(inquiryId);
    } else {
        selectedInquiries.add(inquiryId);
    }
    
    updateBulkActions();
    
    // Update select all checkbox
    const totalCheckboxes = document.querySelectorAll('.inquiry-checkbox').length;
    const selectAll = document.getElementById('selectAll');
    selectAll.indeterminate = selectedInquiries.size > 0 && selectedInquiries.size < totalCheckboxes;
    selectAll.checked = selectedInquiries.size === totalCheckboxes;
}

function updateBulkActions() {
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selected-count');
    
    if (selectedInquiries.size > 0) {
        bulkActions.style.display = 'block';
        selectedCount.textContent = selectedInquiries.size;
    } else {
        bulkActions.style.display = 'none';
    }
}

async function updateInquiryStatus(inquiryId, newStatus) {
    try {
        const response = await fetch(`/api/admin/inquiries/${inquiryId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        if (response.ok) {
            showSuccess('Status updated successfully');
        } else {
            throw new Error('Failed to update status');
        }
    } catch (error) {
        console.error('Error updating status:', error);
        showError('Failed to update status');
        loadInquiries(); // Reload to reset the dropdown
    }
}

async function bulkUpdateStatus(status) {
    if (selectedInquiries.size === 0) return;
    
    try {
        const response = await fetch('/api/admin/inquiries/bulk-update', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                inquiry_ids: Array.from(selectedInquiries),
                status: status
            })
        });
        
        if (response.ok) {
            showSuccess(`${selectedInquiries.size} inquiries updated successfully`);
            selectedInquiries.clear();
            loadInquiries();
        } else {
            throw new Error('Failed to update inquiries');
        }
    } catch (error) {
        console.error('Error updating inquiries:', error);
        showError('Failed to update inquiries');
    }
}

async function exportInquiries() {
    try {
        const params = new URLSearchParams({
            status: document.getElementById('statusFilter').value,
            priority: document.getElementById('priorityFilter').value,
            type: document.getElementById('typeFilter').value,
            search: document.getElementById('searchInput').value
        });
        
        const response = await fetch(`/api/admin/inquiries/export?${params}`);
        const blob = await response.blob();
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `inquiries_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showSuccess('Inquiries exported successfully');
    } catch (error) {
        console.error('Export error:', error);
        showError('Failed to export inquiries');
    }
}

function refreshInquiries() {
    selectedInquiries.clear();
    loadInquiries();
    showSuccess('Inquiries refreshed');
}

function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('priorityFilter').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('searchInput').value = '';
    currentPage = 1;
    loadInquiries();
}

// Utility functions
function getPriorityColor(priority) {
    const colors = {
        'high': 'danger',
        'normal': 'primary',
        'low': 'secondary'
    };
    return colors[priority] || 'secondary';
}

function formatProductInterest(interest) {
    const mapping = {
        'fine-pitch-led': 'Fine Pitch',
        'outdoor-led': 'Outdoor',
        'rental-led': 'Rental',
        'creative-led': 'Creative',
        'transparent-led': 'Transparent',
        'interactive-led': 'Interactive'
    };
    return mapping[interest] || interest;
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function showSuccess(message) {
    showToast(message, 'success');
}

function showError(message) {
    showToast(message, 'danger');
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 5000);
}

// Placeholder functions for future implementation
function viewInquiry(id) {
    alert(`View inquiry #${id} - This feature will be implemented next`);
}

function replyToInquiry(id) {
    alert(`Reply to inquiry #${id} - This feature will be implemented next`);
}

function deleteInquiry(id) {
    if (confirm('Are you sure you want to delete this inquiry?')) {
        // Implementation will be added
        alert('Delete functionality will be implemented');
    }
}

function bulkDelete() {
    if (selectedInquiries.size === 0) return;
    
    if (confirm(`Are you sure you want to delete ${selectedInquiries.size} selected inquiries?`)) {
        // Implementation will be added
        alert('Bulk delete functionality will be implemented');
    }
}
</script>
{% endblock %}
